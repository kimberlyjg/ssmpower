---
title: "Two-Group Comparisons"
author: "Kimberly Gilbert"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Two-Group Comparisons}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ssmpower)
```

## Overview

This vignette covers power analysis and sample size planning for comparing SSM profiles between two independent groups. Common applications include:

- Comparing clinical vs. non-clinical samples
- Comparing treatment vs. control groups
- Comparing diagnostic groups (e.g., depression vs. anxiety)
- Examining gender or age group differences

## The Two-Group Design

In a two-group SSM comparison, you compute SSM parameters (amplitude, elevation, displacement) separately for each group and test whether they differ significantly. The key question is: **How large a sample do I need in each group to detect a meaningful difference?**

## Power for Amplitude Differences

### Basic Power Calculation

Suppose you expect a medium difference in amplitude (0.16) between groups. With 100 participants per group:

```{r}
ssm_power_amplitude_diff(effect = 0.16, n1 = 100, n2 = 100)
```

### Required Sample Size

To achieve 80% power for detecting a medium amplitude difference:

```{r}
ssm_sample_size_amplitude_diff(effect = 0.16, power = 0.80)
```

This tells you that you need **104 participants per group** (208 total) for 80% power.

## Effect Size Benchmarks for Group Differences

The same benchmarks from Zimmermann & Wright (2017) apply to group differences:

| Parameter | Small | Medium | Large |
|-----------|-------|--------|-------|
| Amplitude | 0.10 | 0.16 | 0.23 |
| Elevation | 0.02 | 0.11 | 0.27 |

### Sample Sizes at Each Benchmark

```{r}
# Amplitude differences
cat("AMPLITUDE DIFFERENCES\n")
cat("=====================\n")
for (effect in c(0.10, 0.16, 0.23)) {
  result <- ssm_sample_size_amplitude_diff(effect, power = 0.80)
  cat(sprintf("Effect = %.2f: n = %d per group (%d total)\n", 
              effect, result$n1, result$n_total))
}

cat("\nELEVATION DIFFERENCES\n")
cat("=====================\n")
for (effect in c(0.02, 0.11, 0.27)) {
  result <- ssm_sample_size_elevation_diff(effect, power = 0.80)
  cat(sprintf("Effect = %.2f: n = %d per group (%d total)\n", 
              effect, result$n1, result$n_total))
}
```

## Unbalanced Designs

Sometimes you can't recruit equal numbers in each group. The `ratio` parameter allows for unbalanced designs.

### Example: 2:1 Allocation

If you have easier access to one population (e.g., non-clinical controls), you might use a 2:1 ratio:

```{r}
# 2:1 ratio (n2 = 2 * n1)
result <- ssm_sample_size_amplitude_diff(effect = 0.16, power = 0.80, ratio = 2)
cat(sprintf("Group 1: n = %d\n", result$n1))
cat(sprintf("Group 2: n = %d\n", result$n2))
cat(sprintf("Total N: %d\n", result$n_total))
cat(sprintf("Achieved power: %.3f\n", result$achieved_power))
```

### Comparing Allocation Strategies

```{r}
# Compare different allocation ratios
ratios <- c(1, 1.5, 2, 3)
cat("Allocation Ratio Comparison (Effect = 0.16, Power = 0.80)\n")
cat("=========================================================\n")
cat(sprintf("%-8s %-8s %-8s %-8s\n", "Ratio", "n1", "n2", "Total N"))
cat("---------------------------------------------------------\n")

for (r in ratios) {
  result <- ssm_sample_size_amplitude_diff(0.16, power = 0.80, ratio = r)
  cat(sprintf("%-8.1f %-8d %-8d %-8d\n", r, result$n1, result$n2, result$n_total))
}
```

**Key insight**: Balanced designs (ratio = 1) are most efficient. Unbalanced designs require more total participants but may be necessary for practical reasons.

## Power Tables for Planning

### Amplitude Differences

```{r}
# Create custom power table for two-group amplitude comparisons
effects <- c(0.10, 0.15, 0.20, 0.25)
ns_per_group <- c(50, 75, 100, 125, 150)

cat("Power for Two-Group Amplitude Comparisons\n")
cat("==========================================\n")
cat("(n per group shown; alpha = .05, two-sided)\n\n")

# Header
cat(sprintf("%-10s", "Effect"))
for (n in ns_per_group) {
  cat(sprintf("n=%-7d", n))
}
cat("\n")
cat(paste(rep("-", 50), collapse = ""), "\n")

# Power values
for (e in effects) {
  cat(sprintf("%-10.2f", e))
  for (n in ns_per_group) {
    power <- ssm_power_amplitude_diff(e, n1 = n, n2 = n)$power
    cat(sprintf("%-9.3f", power))
  }
  cat("\n")
}
```

## Elevation Differences

Elevation differences typically require larger samples because of the larger scaling constant (k = 0.60 vs 0.41).

```{r}
# Compare amplitude vs elevation sample requirements
cat("Sample Size Comparison: Amplitude vs Elevation Differences\n")
cat("==========================================================\n")
cat("(80% power, alpha = .05, balanced groups)\n\n")

effects <- c("Small", "Medium", "Large")
amp_effects <- c(0.10, 0.16, 0.23)
elev_effects <- c(0.02, 0.11, 0.27)

cat(sprintf("%-10s %-20s %-20s\n", "Size", "Amplitude (n/group)", "Elevation (n/group)"))
cat(paste(rep("-", 50), collapse = ""), "\n")

for (i in 1:3) {
  amp_n <- ssm_sample_size_amplitude_diff(amp_effects[i], power = 0.80)$n1
  elev_n <- ssm_sample_size_elevation_diff(elev_effects[i], power = 0.80)$n1
  cat(sprintf("%-10s %-20d %-20d\n", effects[i], amp_n, elev_n))
}
```

## Practical Recommendations

### 1. Start with Amplitude

Amplitude differences are usually the primary interest and require smaller samples than elevation differences. Plan your study around amplitude power first.

### 2. Consider Expected Effect Size

- **Large effects (0.23)**: 50 per group is sufficient
- **Medium effects (0.16)**: Plan for ~100 per group
- **Small effects (0.10)**: Need 250+ per group

### 3. Use Balanced Designs When Possible

Equal group sizes maximize power for a given total N.

### 4. Account for Attrition

Add 10-20% to your calculated sample size to account for dropout and missing data.

```{r}
# Example: Accounting for 15% attrition
planned_n <- ssm_sample_size_amplitude_diff(0.16, power = 0.80)$n1
adjusted_n <- ceiling(planned_n / 0.85)
cat(sprintf("Required n per group: %d\n", planned_n))
cat(sprintf("Adjusted for 15%% attrition: %d\n", adjusted_n))
```

## Quick Reference Table

```{r}
cat("\n")
cat("=============================================================\n")
cat("     TWO-GROUP SAMPLE SIZE QUICK REFERENCE (80% Power)\n")
cat("=============================================================\n")
cat("\n")
cat("AMPLITUDE DIFFERENCES\n")
cat("-------------------------------------------------------------\n")
cat("  Small (0.10):  264 per group  |  528 total\n")
cat("  Medium (0.16): 104 per group  |  208 total\n")
cat("  Large (0.23):   50 per group  |  100 total\n")
cat("\n")
cat("ELEVATION DIFFERENCES\n")
cat("-------------------------------------------------------------\n")
cat("  Small (0.02):  17,896 per group  |  35,792 total\n")
cat("  Medium (0.11):    595 per group  |   1,190 total\n")
cat("  Large (0.27):      99 per group  |     198 total\n")
cat("=============================================================\n")
```

## Example: Clinical Study Planning

**Scenario**: You want to compare interpersonal profiles between patients with borderline personality disorder (BPD) and healthy controls. Based on prior research, you expect a medium difference in amplitude.

```{r}
# Primary analysis: amplitude difference
amp_result <- ssm_sample_size_amplitude_diff(effect = 0.16, power = 0.80)

cat("Study Planning: BPD vs. Healthy Controls\n")
cat("========================================\n\n")
cat(sprintf("Primary outcome: Amplitude difference\n"))
cat(sprintf("Expected effect: 0.16 (medium)\n"))
cat(sprintf("Required per group: %d\n", amp_result$n1))
cat(sprintf("Total required: %d\n", amp_result$n_total))
cat(sprintf("With 15%% attrition buffer: %d per group\n", ceiling(amp_result$n1 / 0.85)))
```

## Citation

To cite this package:
Gilbert, K. (2025). *ssmpower: Power Analysis for the Structural Summary Method*. R package version 1.0.0. https://github.com/kimberlyjg/ssmpower
